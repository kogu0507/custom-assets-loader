document.addEventListener('DOMContentLoaded',()=>{document.querySelectorAll('.fc-root').forEach((root,rootIndex)=>{const container=root.querySelector('.fc-card-container');const radios=Array.from(root.querySelectorAll('input[name="fc-flashcard-mode"]'));if(!container){console.warn('Flashcard: .fc-card-container not found in root element.',root);return} const originalOrder=Array.from(container.querySelectorAll('.fc-card'));originalOrder.forEach((card,cardIndex)=>{const btn=card.querySelector('.fc-toggle-answer-btn');const answer=card.querySelector('.fc-answer');if(btn&&answer){const uniqueId=`fc-answer-${rootIndex}-${cardIndex}`;if(!answer.id)answer.setAttribute('id',uniqueId);if(!btn.getAttribute('aria-controls')){btn.setAttribute('aria-controls',answer.id||uniqueId)}}});const shuffleArray=(arr)=>{const a=arr.slice();for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]} return a};const updateCardDisplay=(cards)=>{const activeElement=document.activeElement;container.innerHTML='';cards.forEach((c)=>container.appendChild(c));if(activeElement instanceof HTMLElement&&root.contains(activeElement)){activeElement.focus({preventScroll:!0})}else{const firstBtn=container.querySelector('.fc-toggle-answer-btn');if(firstBtn)firstBtn.focus({preventScroll:!0})}};const getMode=()=>{const checked=radios.find((r)=>r.checked);return checked?checked.value:'study'};const setAnswerVisibility=(answerEl,btnEl,visible)=>{if(!answerEl||!btnEl)return;if(visible){answerEl.removeAttribute('hidden');btnEl.setAttribute('aria-expanded','true');btnEl.textContent='解答を非表示'}else{answerEl.setAttribute('hidden','');btnEl.setAttribute('aria-expanded','false');btnEl.textContent='解答を表示'}};const applyMode=(mode)=>{container.classList.toggle('fc-game-mode-study',mode==='study');container.classList.toggle('fc-game-mode-quiz',mode==='quiz');const cards=Array.from(container.querySelectorAll('.fc-card'));cards.forEach((card)=>{const btn=card.querySelector('.fc-toggle-answer-btn');const answerId=btn&&btn.getAttribute('aria-controls');const answer=answerId?card.querySelector('#'+CSS.escape(answerId)):card.querySelector('.fc-answer');if(mode==='study'){setAnswerVisibility(answer,btn,!0)}else{setAnswerVisibility(answer,btn,!1)}})};applyMode(getMode());radios.forEach((radio)=>{radio.addEventListener('change',()=>{const mode=getMode();const newOrder=mode==='quiz'?shuffleArray(originalOrder):originalOrder;updateCardDisplay(newOrder);applyMode(mode)})});root.addEventListener('click',(ev)=>{const btn=ev.target.closest('.fc-toggle-answer-btn');if(!btn||!root.contains(btn))return;if(!container.classList.contains('fc-game-mode-quiz'))return;const answerId=btn.getAttribute('aria-controls');let answer=null;if(answerId){answer=root.querySelector('#'+CSS.escape(answerId))} if(!answer){answer=btn.nextElementSibling&&btn.nextElementSibling.classList.contains('fc-answer')?btn.nextElementSibling:null} if(!answer)return;const isHidden=answer.hasAttribute('hidden');setAnswerVisibility(answer,btn,isHidden)})})})
