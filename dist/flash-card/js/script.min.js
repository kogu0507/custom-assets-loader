document.addEventListener('DOMContentLoaded',()=>{document.querySelectorAll('.fc-root').forEach((root)=>{const container=root.querySelector('.fc-card-container');const radios=Array.from(root.querySelectorAll('input[name="fc-flashcard-mode"]'));if(!container)return;const originalOrder=Array.from(container.querySelectorAll('.fc-card'));const shuffleArray=(arr)=>{const a=arr.slice();for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]} return a};const updateCardDisplay=(cards)=>{const active=document.activeElement;const activeId=active&&active.id?active.id:null;container.innerHTML='';cards.forEach((c)=>container.appendChild(c));if(active&&root.contains(active)){active.focus({preventScroll:!0})}else{const firstBtn=container.querySelector('.fc-toggle-answer-btn');if(firstBtn)firstBtn.focus({preventScroll:!0})}};const getMode=()=>{const checked=radios.find((r)=>r.checked);return checked?checked.value:'study'};const setAnswerVisibility=(answerEl,btnEl,visible)=>{if(!answerEl||!btnEl)return;if(visible){answerEl.removeAttribute('hidden');btnEl.setAttribute('aria-expanded','true');btnEl.textContent='解答を非表示'}else{answerEl.setAttribute('hidden','');btnEl.setAttribute('aria-expanded','false');btnEl.textContent='解答を表示'}};const applyMode=(mode)=>{container.classList.toggle('fc-game-mode-study',mode==='study');container.classList.toggle('fc-game-mode-quiz',mode==='quiz');const cards=Array.from(container.querySelectorAll('.fc-card'));cards.forEach((card)=>{const btn=card.querySelector('.fc-toggle-answer-btn');const answerId=btn&&btn.getAttribute('aria-controls');const answer=answerId?card.querySelector('#'+CSS.escape(answerId)):card.querySelector('.fc-answer');if(mode==='study'){setAnswerVisibility(answer,btn,!0)}else{setAnswerVisibility(answer,btn,!1)}})};applyMode(getMode());radios.forEach((radio)=>{radio.addEventListener('change',(e)=>{const mode=getMode();if(mode==='quiz'){const shuffled=shuffleArray(originalOrder);updateCardDisplay(shuffled)}else{updateCardDisplay(originalOrder)} applyMode(mode)})});root.addEventListener('click',(ev)=>{const btn=ev.target.closest('.fc-toggle-answer-btn');if(!btn||!root.contains(btn))return;if(!container.classList.contains('fc-game-mode-quiz'))return;const answerId=btn.getAttribute('aria-controls');let answer=answerId?btn.closest('.fc-card')?.querySelector('#'+CSS.escape(answerId)):null;if(!answer){answer=btn.nextElementSibling&&btn.nextElementSibling.classList.contains('fc-answer')?btn.nextElementSibling:null} if(!answer)return;const visible=answer.hasAttribute('hidden')?!1:!0;setAnswerVisibility(answer,btn,!visible)})})})
